<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TIEN TIEN Quick Quotation Generator</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
    .no-print { margin-top: 15px; }
    .totals { font-weight: bold; }
    .print-only { display: none; }
    .icon-btn {
        border: none;
        background: none;
        font-size: 1.3rem;
        margin-left: 8px;
        cursor: pointer;
    }
    @media print {
        .no-print { display: none !important; }
        input.form-control { display: none !important; }
        .print-only { display: table !important; }
        .form-control { border: none !important; }
    }
</style>
</head>
<body class="p-4">

<div class="container" id="quotation-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <img src="transparent_black.png" alt="Logo" style="height:80px;">
        <div class="d-flex align-items-center">
            <h2 class="mb-0">Quick Quotation</h2>
            <!-- Export & Import icons -->
            <button class="icon-btn no-print" title="Export Quotation" onclick="exportXML()">
                <i class="bi bi-download"></i>
            </button>
            <button class="icon-btn no-print" title="Import Quotation" onclick="document.getElementById('importXML').click()">
                <i class="bi bi-upload"></i>
            </button>
            <input type="file" id="importXML" class="d-none" accept=".xml" onchange="importXML(event)">
        </div>
    </div>

    <!-- Customer Info (Input) -->
    <div class="row mb-3 no-print">
        <div class="col-md-6">
            <label>Customer Name</label>
            <input type="text" id="customerName" class="form-control" required oninput="syncPrintFields()">
        </div>
        <div class="col-md-6">
            <label>Contact No</label>
            <input type="text" id="customerContact" class="form-control" required oninput="syncPrintFields()">
        </div>
    </div>
    <div class="row mb-3 no-print">
        <div class="col-md-6">
            <label>Date</label>
            <input type="date" id="quotationDate" class="form-control" required oninput="syncPrintFields()">
        </div>
        <div class="col-md-6">
            <label>Agent Name</label>
            <input type="text" id="agentName" class="form-control" required oninput="syncPrintFields()">
        </div>
    </div>

    <!-- Customer Info (Print) -->
    <table class="table table-bordered print-only mb-3">
        <tr>
            <td><strong>Customer Name:</strong><br /> <span id="printCustomerName"></span></td>
            <td><strong>Contact No:</strong><br /> <span id="printCustomerContact"></span></td>
        </tr>
        <tr>
            <td><strong>Date:</strong><br /> <span id="printQuotationDate"></span></td>
            <td><strong>Agent Name:</strong><br /> <span id="printAgentName"></span></td>
        </tr>
    </table>

    <!-- Items Table -->
    <table class="table table-bordered" id="itemsTable">
        <thead class="thead-light">
            <tr>
                <th>#</th>
                <th>Products</th>
                <th>Codes</th>
                <th>Descriptions</th>
                <th>Quantity</th>
                <th>Selling Price<br /> (MYR)</th>
                <th class="office-only">Cost Price<br /> (MYR)</th>
                <th>Sub-Total<br /> (MYR)</th>
                <th class="office-only">Cost Sub-Total<br /> (MYR)</th>
                <th class="no-print">Action</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td id="grandTotalTitle" colspan="7" class="text-right totals">Grand Total: MYR</td>
                <td id="grandTotalSell">0.00</td>
                <td class="office-only" id="grandTotalCost">0.00</td>
                <td class="no-print"></td>
            </tr>
        </tfoot>
    </table>

    

    <!-- Export Buttons -->
    <div class="no-print text-center mt-3">
		<button class="btn btn-success" onclick="addItem()">+ Add Item</button>
        <button class="btn btn-primary" onclick="printCustomer()">Print Customer Copy</button>
        <button class="btn btn-secondary" onclick="printOffice()">Print Office Copy</button>
    </div>
</div>

<script>
document.getElementById("quotationDate").value = new Date().toISOString().split('T')[0];
syncPrintFields();

/* Sync input --> print-only spans */
function syncPrintFields() {
    document.getElementById("printCustomerName").innerHTML = document.getElementById("customerName").value;
    document.getElementById("printCustomerContact").innerHTML = document.getElementById("customerContact").value;
    document.getElementById("printQuotationDate").innerHTML = document.getElementById("quotationDate").value;
    document.getElementById("printAgentName").innerHTML = document.getElementById("agentName").value;
}

/* Add / remove items */
function addItem() {
    var tbody = document.getElementById("itemsTable").getElementsByTagName("tbody")[0];
    var row = document.createElement("tr");
    row.innerHTML =
        '<td class="row-number"></td>' +
        '<td contenteditable="true">Item</td>' +
        '<td contenteditable="true">Code</td>' +
        '<td contenteditable="true">Description</td>' +
        '<td><input type="number" value="1" min="1" required class="form-control" oninput="updateRow(this)"><span class="print-only"></span></td>' +
        '<td><input type="number" value="0" min="0" required class="form-control" oninput="updateRow(this)"><span class="print-only"></span></td>' +
        '<td class="office-only"><input type="number" value="0" min="0" required class="form-control" oninput="updateRow(this)"><span class="print-only"></span></td>' +
        '<td class="subtotalSell">0.00</td>' +
        '<td class="subtotalCost office-only">0.00</td>' +
        '<td class="no-print"><button class="btn btn-danger btn-sm" onclick="removeItem(this)">Remove</button></td>';
    tbody.appendChild(row);
    renumberRows();
    updateTotals();
}

function removeItem(button) {
    button.parentNode.parentNode.remove();
    renumberRows();
    updateTotals();
}

/* Row numbers */
function renumberRows() {
    var rows = document.querySelectorAll("#itemsTable tbody tr");
    for (var i = 0; i < rows.length; i++) {
        rows[i].querySelector(".row-number").innerHTML = (i + 1);
    }
}

/* Update print spans and totals when input changes */
function updateRow(input) {
    var span = input.nextElementSibling;
    span.innerHTML = input.value;
    updateTotals();
}

/* Totals calculation */
function updateTotals() {
    var rows = document.querySelectorAll("#itemsTable tbody tr");
    var grandSell = 0;
    var grandCost = 0;

    for (var i = 0; i < rows.length; i++) {
        var qty = parseFloat(rows[i].querySelector('td:nth-child(5) input').value) || 0;
        var sell = parseFloat(rows[i].querySelector('td:nth-child(6) input').value) || 0;
        var cost = 0;
        if (rows[i].querySelector('td:nth-child(7) input')) {
            cost = parseFloat(rows[i].querySelector('td:nth-child(7) input').value) || 0;
        }

        rows[i].querySelector('td:nth-child(5) span').innerHTML = qty;
        rows[i].querySelector('td:nth-child(6) span').innerHTML = sell.toFixed(2);
        if (rows[i].querySelector('td:nth-child(7) span')) {
            rows[i].querySelector('td:nth-child(7) span').innerHTML = cost.toFixed(2);
        }

        var subtotalSell = qty * sell;
        var subtotalCost = qty * cost;

        rows[i].querySelector(".subtotalSell").innerHTML = subtotalSell.toFixed(2);
        if (rows[i].querySelector(".subtotalCost")) {
            rows[i].querySelector(".subtotalCost").innerHTML = subtotalCost.toFixed(2);
        }

        grandSell += subtotalSell;
        grandCost += subtotalCost;
    }

    document.getElementById("grandTotalSell").innerHTML = grandSell.toFixed(2);
    document.getElementById("grandTotalCost").innerHTML = grandCost.toFixed(2);
}

/* Simple required-field validation */
function validateForm() {
    var requiredInputs = document.querySelectorAll("input[required]");
    for (var i = 0; i < requiredInputs.length; i++) {
        if (!requiredInputs[i].value) {
            alert("Please fill all required fields.");
            return false;
        }
    }
    return true;
}

/* Adjust the Grand Total title colspan so printed layout aligns correctly. */
function adjustGrandTotalColspan(show) {
    var ths = document.querySelectorAll("#itemsTable thead th");
    var visibleCols = 0;
    ths.forEach(function(th) {
        if (th.classList.contains('no-print')) return;
        if (th.classList.contains('office-only') && !show) return;
        visibleCols++;
    });
    var titleColspan = visibleCols - 1 - (show ? 1 : 0);
    if (titleColspan < 1) titleColspan = 1;
    var titleCell = document.getElementById('grandTotalTitle');
    if (titleCell) titleCell.colSpan = titleColspan;
}

/* Toggle display of office-only columns */
function toggleOfficeCols(show) {
    var elems = document.querySelectorAll(".office-only");
    for (var i = 0; i < elems.length; i++) {
        elems[i].style.display = show ? "" : "none";
    }
    adjustGrandTotalColspan(show);
}

/* Print flows */
function printCustomer() {
    if (!validateForm()) return;
    syncPrintFields();
    toggleOfficeCols(false);
    setTimeout(function() {
        window.print();
        toggleOfficeCols(true);
    }, 50);
}

function printOffice() {
    if (!validateForm()) return;
    syncPrintFields();
    toggleOfficeCols(true);
    setTimeout(function() {
        window.print();
    }, 50);
}

/* Export XML */
function exportXML() {
    var xmlDoc = document.implementation.createDocument("", "", null);
    var quotation = xmlDoc.createElement("quotation");

    ["customerName", "customerContact", "quotationDate", "agentName"].forEach(id => {
        var el = xmlDoc.createElement(id);
        el.textContent = document.getElementById(id).value;
        quotation.appendChild(el);
    });

    var itemsEl = xmlDoc.createElement("items");
    var rows = document.querySelectorAll("#itemsTable tbody tr");
    rows.forEach(row => {
        var itemEl = xmlDoc.createElement("item");
        var product = row.cells[1].innerText;
        var code = row.cells[2].innerText;
        var description = row.cells[3].innerText;
        var qty = row.querySelector('td:nth-child(5) input').value;
        var sell = row.querySelector('td:nth-child(6) input').value;
        var cost = row.querySelector('td:nth-child(7) input') ? row.querySelector('td:nth-child(7) input').value : 0;

        [["product", product], ["code", code], ["description", description], ["qty", qty], ["sell", sell], ["cost", cost]].forEach(([k, v]) => {
            var el = xmlDoc.createElement(k);
            el.textContent = v;
            itemEl.appendChild(el);
        });

        itemsEl.appendChild(itemEl);
    });
    quotation.appendChild(itemsEl);

    xmlDoc.appendChild(quotation);

    var serializer = new XMLSerializer();
    var xmlString = serializer.serializeToString(xmlDoc);

    var date = document.getElementById("quotationDate").value || "no_date";
    var customer = document.getElementById("customerName").value || "no_name";
    var contact = document.getElementById("customerContact").value || "no_contact";
    var agent = document.getElementById("agentName").value || "no_agent";

    function clean(str) {
        return str.replace(/[^a-z0-9_-]/gi, "_");
    }

    var filename = `${clean(date)}-${clean(customer)}-${clean(contact)}-${clean(agent)}.xml`;

    var blob = new Blob([xmlString], {type: "application/xml"});
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

/* Import XML */
function importXML(event) {
    var file = event.target.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
        var parser = new DOMParser();
        var xmlDoc = parser.parseFromString(e.target.result, "application/xml");

        document.getElementById("customerName").value = xmlDoc.getElementsByTagName("customerName")[0]?.textContent || "";
        document.getElementById("customerContact").value = xmlDoc.getElementsByTagName("customerContact")[0]?.textContent || "";
        document.getElementById("quotationDate").value = xmlDoc.getElementsByTagName("quotationDate")[0]?.textContent || "";
        document.getElementById("agentName").value = xmlDoc.getElementsByTagName("agentName")[0]?.textContent || "";
        syncPrintFields();

        var tbody = document.querySelector("#itemsTable tbody");
        tbody.innerHTML = "";
        var items = xmlDoc.getElementsByTagName("item");
        for (var i = 0; i < items.length; i++) {
            addItem();
            var row = tbody.lastChild;
            row.cells[1].innerText = items[i].getElementsByTagName("product")[0]?.textContent || "";
            row.cells[2].innerText = items[i].getElementsByTagName("code")[0]?.textContent || "";
            row.cells[3].innerText = items[i].getElementsByTagName("description")[0]?.textContent || "";
            row.querySelector('td:nth-child(5) input').value = items[i].getElementsByTagName("qty")[0]?.textContent || 0;
            row.querySelector('td:nth-child(6) input').value = items[i].getElementsByTagName("sell")[0]?.textContent || 0;
            if (row.querySelector('td:nth-child(7) input')) {
                row.querySelector('td:nth-child(7) input').value = items[i].getElementsByTagName("cost")[0]?.textContent || 0;
            }
            updateTotals();
        }
    };
    reader.readAsText(file);
}

/* Initial setup */
document.addEventListener('DOMContentLoaded', function() {
    toggleOfficeCols(true);
    updateTotals();
});
</script>

</body>
</html>
