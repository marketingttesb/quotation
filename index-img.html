<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TIEN TIEN Quick Quotation Generator | Beta 3.5</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<!-- html2canvas for image export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
    .no-print { margin-top: 15px; }
    .totals { font-weight: bold; }
    .print-only { display: none; }
	.print-onlys { display: none; }
    .icon-btn {
        border: none;
        background: none;
        font-size: 1.3rem;
        margin-left: 8px;
        cursor: pointer;
    }
    table { width: 100% !important; }
    @media print {
        .no-print { display: none !important; }
        input.form-control, select.form-control { display: none !important; }
        .print-only { display: flex !important; justify-content: space-between; }
        .form-control { border: none !important; }

        /* strike through the Grand Total sell value in customer copy */
        #grandTotalSell.customer-copy {
            text-decoration: line-through;
        }
        #cust-table {
            width: 100%;
        }

        /* default hide discounted row */
        .print-onlys { display: none !important; }
        /* show only when printing customer copy */
        body.customer-copy-print .print-onlys { display: table-row !important; }
    }

    /* small helper for replaced input spans in print clone */
    .printed-value { white-space: nowrap; }
</style>
</head>
<body class="p-4">

<div class="container" id="quotation-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <img src="transparent_black.png" alt="Logo" style="height:80px;">
        <div class="d-flex align-items-center">
            <h2 class="mb-0">Quick Quotation</h2>
            <button class="icon-btn no-print" title="Export Quotation" onclick="exportJSON()">
                <i class="bi bi-download"></i>
            </button>
            <button class="icon-btn no-print" title="Import Quotation" onclick="document.getElementById('importJSON').click()">
                <i class="bi bi-upload"></i>
            </button>
            <input type="file" id="importJSON" class="d-none" accept=".json" onchange="importJSON(event)">
        </div>
    </div>

    <!-- Customer Info (Input) -->
    <div class="row mb-3 no-print">
        <div class="col-md-9">
            <label>Customer Name</label>
            <input type="text" id="customerName" class="form-control" required oninput="syncPrintFields()">
        </div>
        <div class="col-md-3">
            <label>Date</label>
            <input type="date" id="quotationDate" class="form-control" required oninput="syncPrintFields()">
        </div>
    </div>

    <!-- Customer Info (Print) -->
	<div class="print-only mb-3 w-100">
		<div><strong>Customer Name:</strong> <span id="printCustomerName"></span></div>
		<div><strong>Date:</strong> <span id="printQuotationDate"></span></div>
	</div>

    <!-- Items Table -->
    <table class="table table-bordered" id="itemsTable">
        <thead class="thead-light">
            <tr>
                <th>#</th>
                <th>Products</th>
                <th>Quantity</th>
                <th>Price(RM)</th>
                <th class="office-only">PM Price(RM)</th>
                <th>Total(RM)</th>
                <th class="office-only">Total PM Price(RM)</th>
                <th class="no-print">&nbsp;</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr id="grandTotalRow">
                <td id="grandTotalTitle" class="text-right totals">Grand Total: RM</td>
                <td id="grandTotalSell">0.00</td>
                <td class="office-only" id="grandTotalCost">0.00</td>
                <td class="no-print"></td>
            </tr>
            <!-- Fixed row for customer copy -->
            <tr id="customerGrandCostRow" class="print-onlys">
                <td id="customerGrandTitle" class="text-right totals">Discounted Price: RM</td>
                <td id="grandTotalCostCustomer">0.00</td>
            </tr>
        </tfoot>
    </table>

    <!-- Terms & Prepared By (Print Only) -->
    <div class="print-only mt-3">
        <p id="quotationValidity" class="font-weight-bold"></p>
        <p id="preparedBy"></p>
    </div>

    <!-- Bottom Controls -->
    <div class="no-print d-flex align-items-center mt-3">
        <div class="mr-3">
            <select id="agentName" class="form-control" required onchange="syncPrintFields()">
                <option value="">Please Select An Agent</option>
            </select>
        </div>
        <div class="align-items-right">
            <button class="btn btn-success bi-plus-circle mr-2" onclick="addItem()"> Add Item</button> | 
			Customer Copy <button class="btn btn-primary bi-printer mr-2" onclick="printCustomer()"></button> <button class="btn btn-info bi-image mr-2" onclick="exportAsImage('customer')"></button> | 
            Office Copy <button class="btn btn-warning bi-printer mr-2" onclick="printOffice()"></button> <button class="btn btn-secondary bi-image mr-2" onclick="exportAsImage('office')"></button>

        </div>
    </div>
</div>

<script>
document.getElementById("quotationDate").value = new Date().toISOString().split('T')[0];
syncPrintFields();

/* --------- syncing print fields --------- */
function syncPrintFields() {
    document.getElementById("printCustomerName").innerHTML = document.getElementById("customerName").value;
    document.getElementById("printQuotationDate").innerHTML = document.getElementById("quotationDate").value;

    let dateVal = document.getElementById("quotationDate").value;
    if (dateVal) {
        let d = new Date(dateVal);
        d.setDate(d.getDate() + 30);
        let options = { year: 'numeric', month: 'long', day: '2-digit' };
        document.getElementById("quotationValidity").innerHTML = "*This quotation valid until " + d.toLocaleDateString('en-GB', options);
    }

    let agent = document.getElementById("agentName").value;
    document.getElementById("preparedBy").innerHTML = agent ? "Prepared By: " + agent : "";
}

/* --------- items management --------- */
function addItem() {
    var tbody = document.getElementById("itemsTable").getElementsByTagName("tbody")[0];
    var row = document.createElement("tr");
    row.innerHTML =
        '<td class="row-number"></td>' +
        '<td contenteditable="true">Item</td>' +
        '<td><input type="number" value="1" min="1" required class="form-control" oninput="updateRow(this)"><span class="print-only"></span></td>' +
        '<td><input type="number" value="0" min="0" required class="form-control" oninput="updateRow(this)"><span class="print-only"></span></td>' +
        '<td class="office-only"><input type="number" value="0" min="0" required class="form-control" oninput="updateRow(this)"><span class="print-only"></span></td>' +
        '<td class="subtotalSell">0.00</td>' +
        '<td class="subtotalCost office-only">0.00</td>' +
        '<td class="no-print"><button class="btn btn-danger btn-sm bi-trash3" onclick="removeItem(this)"></button></td>';
    tbody.appendChild(row);
    renumberRows();
    updateTotals();
}

function removeItem(button) {
    button.parentNode.parentNode.remove();
    renumberRows();
    updateTotals();
}

function renumberRows() {
    var rows = document.querySelectorAll("#itemsTable tbody tr");
    for (var i = 0; i < rows.length; i++) {
        rows[i].querySelector(".row-number").innerHTML = (i + 1);
    }
}

function updateRow(input) {
    var span = input.nextElementSibling;
    span.innerHTML = input.value;
    updateTotals();
}

/* --------- totals --------- */
function updateTotals() {
    var rows = document.querySelectorAll("#itemsTable tbody tr");
    var grandSell = 0;
    var grandCost = 0;

    for (var i = 0; i < rows.length; i++) {
        var qty = parseFloat(rows[i].querySelector('td:nth-child(3) input').value) || 0;
        var sell = parseFloat(rows[i].querySelector('td:nth-child(4) input').value) || 0;
        var cost = rows[i].querySelector('td:nth-child(5) input') ? parseFloat(rows[i].querySelector('td:nth-child(5) input').value) || 0 : 0;

        rows[i].querySelector('td:nth-child(3) span').innerHTML = qty;
        rows[i].querySelector('td:nth-child(4) span').innerHTML = sell.toFixed(2);
        if (rows[i].querySelector('td:nth-child(5) span')) {
            rows[i].querySelector('td:nth-child(5) span').innerHTML = cost.toFixed(2);
        }

        var subtotalSell = qty * sell;
        var subtotalCost = qty * cost;

        rows[i].querySelector(".subtotalSell").innerHTML = subtotalSell.toFixed(2);
        if (rows[i].querySelector(".subtotalCost")) {
            rows[i].querySelector(".subtotalCost").innerHTML = subtotalCost.toFixed(2);
        }

        grandSell += subtotalSell;
        grandCost += subtotalCost;
    }

    document.getElementById("grandTotalSell").innerHTML = grandSell.toFixed(2);
    document.getElementById("grandTotalCost").innerHTML = grandCost.toFixed(2);
    document.getElementById("grandTotalCostCustomer").innerHTML = grandCost.toFixed(2);
    updateColspans(false);
}

/* --------- form validation --------- */
function validateForm() {
    var requiredInputs = document.querySelectorAll("input[required], select[required]");
    for (var i = 0; i < requiredInputs.length; i++) {
        if (!requiredInputs[i].value) {
            alert("Please fill all required fields.");
            return false;
        }
    }
    return true;
}

/* --------- dynamic colspan management --------- */
function updateColspans(printMode) {
    const ths = Array.from(document.querySelectorAll("#itemsTable thead th"));
    let visible = 0;
    ths.forEach(th => {
        if (printMode && th.classList.contains('no-print')) return;
        if (printMode && th.classList.contains('office-only')) return;
        const style = window.getComputedStyle(th);
        if (style.display !== 'none' && style.visibility !== 'collapse') visible++;
    });
    const officeVisible = ths.some(th => th.classList.contains('office-only') && window.getComputedStyle(th).display !== 'none');
    const actionVisible = !printMode && ths.some(th => th.classList.contains('no-print') && window.getComputedStyle(th).display !== 'none');
    const rightSideCells = 1 + (officeVisible ? 1 : 0) + (actionVisible ? 1 : 0);
    const titleColspan = Math.max(1, visible - rightSideCells);
    const titleCell = document.getElementById('grandTotalTitle');
    if (titleCell) titleCell.colSpan = titleColspan;
    if (printMode) {
        const custColSpan = Math.max(1, visible - 1);
        const customerTitle = document.getElementById('customerGrandTitle');
        if (customerTitle) customerTitle.colSpan = custColSpan;
    }
}

/* --------- show/hide office columns --------- */
function toggleOfficeCols(show) {
    var elems = document.querySelectorAll(".office-only");
    for (var i = 0; i < elems.length; i++) {
        elems[i].style.display = show ? "" : "none";
    }
    updateColspans(false);
}

/* --------- printing flow (unchanged) --------- */
function printCustomer() {
    if (!validateForm()) return;
    syncPrintFields();
    toggleOfficeCols(false);
    updateColspans(true);
    document.body.classList.add("customer-copy-print");
    document.getElementById("grandTotalSell").classList.add("customer-copy");

    setTimeout(function() {
        window.print();
        toggleOfficeCols(true);
        updateColspans(false);
        document.body.classList.remove("customer-copy-print");
        document.getElementById("grandTotalSell").classList.remove("customer-copy");
    }, 60);
}

function printOffice() {
    if (!validateForm()) return;
    syncPrintFields();
    toggleOfficeCols(true);
    updateColspans(false);
    document.body.classList.remove("customer-copy-print");
    document.getElementById("grandTotalSell").classList.remove("customer-copy");
    setTimeout(function() {
        window.print();
    }, 60);
}

/* --------- export/import JSON (unchanged) --------- */
function exportJSON() {
    var data = {
        customerName: document.getElementById("customerName").value,
        quotationDate: document.getElementById("quotationDate").value,
        agentName: document.getElementById("agentName").value,
        items: []
    };
    var rows = document.querySelectorAll("#itemsTable tbody tr");
    rows.forEach(row => {
        data.items.push({
            product: row.cells[1].innerText,
            qty: row.querySelector('td:nth-child(3) input').value,
            sell: row.querySelector('td:nth-child(4) input').value,
            cost: row.querySelector('td:nth-child(5) input') ? row.querySelector('td:nth-child(5) input').value : 0
        });
    });
    var jsonString = JSON.stringify(data, null, 2);
    function clean(str) { return str.replace(/[^a-z0-9_-]/gi, "_"); }
    var date = document.getElementById("quotationDate").value || "no_date";
    var customer = document.getElementById("customerName").value || "no_name";
    var agent = document.getElementById("agentName").value || "no_agent";
    var now = new Date();
    var hh = String(now.getHours()).padStart(2, "0");
    var mm = String(now.getMinutes()).padStart(2, "0");
    var ss = String(now.getSeconds()).padStart(2, "0");
    var timestamp = `${hh}${mm}${ss}`;
    var filename = `${clean(date)}-${timestamp}-${clean(customer)}-${clean(agent)}.json`;
    var blob = new Blob([jsonString], {type: "application/json"});
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

function importJSON(event) {
    var file = event.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        var data = JSON.parse(e.target.result);
        document.getElementById("customerName").value = data.customerName || "";
        document.getElementById("quotationDate").value = data.quotationDate || "";
        document.getElementById("agentName").value = data.agentName || "";
        syncPrintFields();
        var tbody = document.querySelector("#itemsTable tbody");
        tbody.innerHTML = "";
        if (data.items) {
            data.items.forEach(item => {
                addItem();
                var row = tbody.lastChild;
                row.cells[1].innerText = item.product || "";
                row.querySelector('td:nth-child(3) input').value = item.qty || 0;
                row.querySelector('td:nth-child(4) input').value = item.sell || 0;
                if (row.querySelector('td:nth-child(5) input')) {
                    row.querySelector('td:nth-child(5) input').value = item.cost || 0;
                }
                updateTotals();
            });
        }
    };
    reader.readAsText(file);
}

/* --------- export print-layout to image: helper (updated to clone + copy live values) --------- */
function capturePrintAsImage(mode) {
    if (!validateForm()) return;
    syncPrintFields();

    // Prepare original in print-like state so computed colspans & styles are applied, then clone
    if (mode === 'customer') {
        toggleOfficeCols(false);
        updateColspans(true);
        document.body.classList.add("customer-copy-print");
        document.getElementById("grandTotalSell").classList.add("customer-copy");
    } else {
        toggleOfficeCols(true);
        updateColspans(false);
        document.body.classList.remove("customer-copy-print");
        document.getElementById("grandTotalSell").classList.remove("customer-copy");
    }

    const container = document.getElementById("quotation-container");
    const clone = container.cloneNode(true);

    // Copy live control values from the original into the clone (so user-edited fields are preserved)
    const origControls = container.querySelectorAll('input, select, textarea');
    const cloneControls = clone.querySelectorAll('input, select, textarea');
    for (let i = 0; i < cloneControls.length; i++) {
        const c = cloneControls[i];
        const o = origControls[i];
        if (!o) continue;
        const tag = c.tagName.toLowerCase();
        if (tag === 'select') {
            c.selectedIndex = o.selectedIndex;
        } else if (c.type === 'checkbox' || c.type === 'radio') {
            c.checked = o.checked;
        } else {
            c.value = o.value;
            c.setAttribute('value', o.value);
        }
    }

    // Copy contenteditable text (product names) as well
    const origEditables = container.querySelectorAll('[contenteditable]');
    const cloneEditables = clone.querySelectorAll('[contenteditable]');
    for (let i = 0; i < cloneEditables.length; i++) {
        if (origEditables[i]) cloneEditables[i].innerHTML = origEditables[i].innerHTML;
    }

    // Revert original immediately so the UI doesn't stay in print-mode
    if (mode === 'customer') {
        toggleOfficeCols(true);
        updateColspans(false);
        document.body.classList.remove("customer-copy-print");
        document.getElementById("grandTotalSell").classList.remove("customer-copy");
    }

    // Prepare clone to look like the printed page:
    function prepareCloneForPrint(root) {
        // remove interactive elements (.no-print)
        const noPrints = root.querySelectorAll('.no-print');
        noPrints.forEach(el => el.remove());

        // Replace inputs/selects/textareas with simple spans showing value
        const controls = root.querySelectorAll('input, select, textarea');
        controls.forEach(ctrl => {
            const span = document.createElement('span');
            if (ctrl.tagName.toLowerCase() === 'select') {
                span.textContent = (ctrl.options[ctrl.selectedIndex] ? ctrl.options[ctrl.selectedIndex].text : ctrl.value) || '';
            } else {
                if (ctrl.type === 'checkbox' || ctrl.type === 'radio') {
                    span.textContent = ctrl.checked ? 'Yes' : 'No';
                } else {
                    span.textContent = ctrl.value || '';
                }
            }
            span.className = 'printed-value';
            // Replace the control
            if (ctrl.parentNode) ctrl.parentNode.replaceChild(span, ctrl);
        });

        // Remove any contenteditable attribute (we want plain text)
        const editables = root.querySelectorAll('[contenteditable]');
        editables.forEach(el => el.removeAttribute('contenteditable'));

        // Show print-only elements
        const printOnlyEls = root.querySelectorAll('.print-only');
        printOnlyEls.forEach(el => {
            if (el.tagName.toLowerCase() === 'div') el.style.display = 'flex';
            else el.style.display = '';
        });

        // Handle the special discounted row (print-onlys)
        const printOnlysRows = root.querySelectorAll('.print-onlys');
        printOnlysRows.forEach(el => {
            el.style.display = (mode === 'customer') ? 'table-row' : 'none';
        });

        // Office-only columns: show only on office mode
        const officeCols = root.querySelectorAll('.office-only');
        officeCols.forEach(el => {
            el.style.display = (mode === 'office') ? '' : 'none';
        });

        // For customer mode, add strike-through class to grand total in the clone
        if (mode === 'customer') {
            const g = root.querySelector('#grandTotalSell');
            if (g) g.classList.add('customer-copy');
        } else {
            const g = root.querySelector('#grandTotalSell');
            if (g) g.classList.remove('customer-copy');
        }
    }

    prepareCloneForPrint(clone);

    // Wrap clone in a clean wrapper so html2canvas captures only the print view.
    const wrapper = document.createElement('div');
    wrapper.id = 'print-capture-wrapper';
    wrapper.style.width = '794px'; // ~210mm at 96dpi
    wrapper.style.backgroundColor = '#ffffff';
    wrapper.style.padding = '16px';
    wrapper.style.position = 'fixed';
    wrapper.style.left = '50%';
    wrapper.style.top = '50%';
    wrapper.style.transform = 'translate(-50%,-50%)';
    wrapper.style.zIndex = '999999';
    wrapper.style.boxShadow = '0 0 0 rgba(0,0,0,0)';
    wrapper.appendChild(clone);

    document.body.appendChild(wrapper);

    // small delay so fonts/images/layout settle
    setTimeout(() => {
        html2canvas(wrapper, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff',
            scrollY: -window.scrollY // ensure stable capture
        }).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            const now = new Date();
            const timestamp = `${String(now.getFullYear())}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            link.download = `quotation-${mode}-${timestamp}.png`;
            link.click();
        }).catch(err => {
            console.error('html2canvas error', err);
            alert('Failed to export image â€” check console for details.');
        }).finally(() => {
            // clean up
            if (wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
        });
    }, 150);
}

// simplified export entry that uses the clone-based capture above
function exportAsImage(copyType) {
    capturePrintAsImage(copyType);
}

/* --------- initial setup --------- */
document.addEventListener('DOMContentLoaded', function() {
    toggleOfficeCols(true);
    updateTotals();
    fetch("agent.json")
        .then(res => res.json())
        .then(data => {
            let select = document.getElementById("agentName");
            data.forEach(agent => {
                let opt = document.createElement("option");
                opt.value = agent.name;
                opt.textContent = agent.name;
                select.appendChild(opt);
            });
        })
        .catch(err => console.error("Error loading agent.json", err));
});
</script>

</body>
</html>
